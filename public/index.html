<html ng-app="bidApp">
    <head>
        <meta charset="utf-8">
        <title>Bid App</title>
        <script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
    </head>
    <script>
        //this is an ugly front end to demonstrate what the server can currently do
        //if you are currently logged in and refresh the page the jwt will still exist even though the message won't say so
        var bidApp = angular.module('bidApp', [])
        bidApp.controller('login', ['$scope', '$http', function ($scope, $http) {
            //login
            $scope.loginUsername = ""
            $scope.loginPassword = ""
            //register
            $scope.regUsername = ""
            $scope.regPassword = ""
            $scope.name = ""
            $scope.email = ""
            $scope.phone = ""
            //"logged in"/"logged out"
            $scope.msg = ""
            //bid amount
            $scope.bidAmount = ""
            $scope.lotID = ""

            $scope.displayLots = false
            var lots = []

            $http({
                method: 'GET',
                url: '/map',
                data: null
            }).then(function success(res) {
                lots = res.data
                $scope.displayLots = true

            }, function err(res) {
                console.log('error getting lots')
            })

            $scope.login = function() {
                if ($scope.loginUsername && $scope.loginPassword) {
                    $http({
                        method: 'POST',
                        url: '/login',
                        data: {username: $scope.loginUsername,
                               password: $scope.loginPassword}
                    }).then(function success(res) {
                        console.log('success login')
                        const data = res.data
                        //if user received jwt
                        if (data.token) {
                            $scope.msg = "logged in"
                            localStorage.setItem("token", data.token)
                        } else {
                            console.log("No token received")
                        }
                    }, function err(res) {
                        console.log('error logging in')
                        console.log(res)
                    })
                }
            }
            $scope.register = function() {
                if ($scope.regUsername && $scope.regPassword && $scope.email && $scope.name && $scope.phone) {
                    $http({
                        method: 'POST',
                        url: '/register',
                        data: {name: $scope.name,
                               username: $scope.regUsername,
                               password: $scope.regPassword,
                               email: $scope.email,
                               phone: $scope.phone}
                    }).then(function success(res) {
                        console.log(res)
                        console.log('success register')
                    }, function err(res) {
                        console.log(res)
                        console.log('error registering')
                    })
                }
            }

            $scope.avgbid = function() {
                if ($scope.bidAmount) {
                    $http({
                        method: 'GET',
                        url: '/avgbid/' + lots[Math.floor(Math.random() * lots.length)]['lotID'],
                        data: null,
                        headers: {'Authorization': 'JWT ' + localStorage.getItem("token")}
                    }).then(function success(res) {
                        console.log(res.data)
                    }, function err(res) {
                        console.log(res)
                        console.log("error retrieving average bid")
                    })
                }
            }

            $scope.bid = function() {
                if ($scope.bidAmount) {
                    $http({
                        method: 'POST',
                        url: '/bid',
                        data: {bid: $scope.bidAmount,
                               lotID: lots[Math.floor(Math.random() * lots.length)]['lotID']},
                        headers: {'Authorization': 'JWT ' + localStorage.getItem("token")}
                    }).then(function success(res) {
                        console.log(res.data)
                    }, function err(res) {
                        console.log(res)
                        console.log("error bidding")
                    })
                }
            }

            //prints message in console if you are currently logged in (in other words if you have a valid jwt)
            $scope.getSecret = function() {
                $http({
                    method: 'GET',
                    url: '/secret',
                    data: null,
                    headers: {'Authorization': 'JWT ' + localStorage.getItem("token")}
                }).then(function success(res) {
                    console.log(res.data)
                }, function err(res) {
                    console.log(res)
                })
            }

            

            /* This is the login status checker I just added */

            $scope.loginStatus = function() {
                $http({
                    method: 'GET',
                    url: '/loginstatus',
                    data: null,
                    headers: {'Authorization': 'JWT ' + localStorage.getItem("token")}
                }).then(function success(res) {
                    //if you are in this success path that means you are logged in but I added the loggedIn property, we can remove that if you feel it is unnecessary
                    //res.data.loggedIn
                    //res.data.username
                    console.log(res.data)
                }, function err(res) {
                    console.log(res)
                })
            }



            //deletes jwt from local storage
            $scope.logout = function() {
                localStorage.removeItem("token")
                $scope.msg = "logged out"
            }
        }])
    </script>
    <body ng-controller="login">

    <label>Register</label>
    <form ng-submit="register()">
        <input type="text" ng-model="name" placeholder="full name">
        <input type="text" ng-model="regUsername" placeholder="username">
        <input type="text" ng-model="regPassword" placeholder="password">
        <input type="text" ng-model="email" placeholder="email">
        <input type="text" ng-model="phone" placeholder="phone number">
        <input type="submit" value="register">
    </form>

    <label>Login</label>
    <form ng-submit="login()">
        <input type="text" ng-model="loginUsername" placeholder="username">
        <input type="text" ng-model="loginPassword" placeholder="password">
        <input type="submit" value="login">
    </form>

    $<input type="text" ng-model="bidAmount" placeholder="bid amount">
    <button ng-click="bid()" ng-if="displayLots">place bid on random lot</button>
    <button ng-click="avgbid()" ng-if="displayLots">request average bid on random lot</button>
    <br>
    <button ng-click="loginStatus()">Logged in?</button>
    <button ng-click="getSecret()">Get Secret</button>
    <button ng-click="logout()">Log Out</button>
    <div>{{msg}}</div>
    </body>